<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Embed API. # The Embed API allows embedding the Cyber compiler and VM as a library into applications. Cyber&rsquo;s core types and the CLI app were built using the Embed API.
The API is defined in the C header file. The examples shown below can be found in the repository under c-embedded. C is used as the host language, but it can be easily translated to C++ or any C-ABI compatible language."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Embedding"><meta property="og:description" content="Embed API. # The Embed API allows embedding the Cyber compiler and VM as a library into applications. Cyber&rsquo;s core types and the CLI app were built using the Embed API.
The API is defined in the C header file. The examples shown below can be found in the repository under c-embedded. C is used as the host language, but it can be easily translated to C++ or any C-ABI compatible language."><meta property="og:type" content="article"><meta property="og:url" content="https://fubark.github.io/cyber/docs/toc/embedding/"><meta property="article:section" content="docs"><title>Embedding | Cyber Docs v0.3</title>
<link rel=manifest href=/cyber/manifest.json><link rel=icon href=/cyber/favicon.png><link rel=stylesheet href=/cyber/book.min.4f0117e74e5337280f18eb9641eae520cb4b25adcf5dd64fafad4664145a5957.css integrity="sha256-TwEX505TNygPGOuWQerlIMtLJa3PXdZPr61GZBRaWVc=" crossorigin=anonymous><script defer src=/cyber/flexsearch.min.js></script><script defer src=/cyber/en.search.min.54914396522947ee2cd15cfb7cfb84c86d5e41d03376665e9b92e44f3871f1ee.js integrity="sha256-VJFDllIpR+4s0Vz7fPuEyG1eQdAzdmZem5LkTzhx8e4=" crossorigin=anonymous></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel=stylesheet><link rel=stylesheet href=/cyber/hljs.min.css><link rel=stylesheet href=/cyber/style.css></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/cyber/><span>Cyber Docs v0.3</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://cyberscript.dev target=_blank rel=noopener>Homepage</a></li><li><a href=https://cyberscript.dev/play.html target=_blank rel=noopener>Playground</a></li></ul><ul><li class=book-section-flat><span>Table of Contents</span><ul><li><a href=/cyber/docs/toc/syntax/>Syntax</a></li><li><a href=/cyber/docs/toc/data-types/>Data Types</a></li><li><a href=/cyber/docs/toc/control-flow/>Control Flow</a></li><li><a href=/cyber/docs/toc/functions/>Functions</a></li><li><a href=/cyber/docs/toc/modules/>Modules</a></li><li><a href=/cyber/docs/toc/ffi/>FFI</a></li><li><a href=/cyber/docs/toc/errors/>Error Handling</a></li><li><a href=/cyber/docs/toc/concurrency/>Concurrency</a></li><li><a href=/cyber/docs/toc/type-system/>Type System</a></li><li><a href=/cyber/docs/toc/metaprogramming/>Metaprogramming</a></li><li><a href=/cyber/docs/toc/embedding/ class=active>Embedding</a></li><li><a href=/cyber/docs/toc/memory/>Memory</a></li><li><a href=/cyber/docs/toc/aot-jit/>AOT/JIT</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/cyber/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Embedding</strong>
<label for=toc-control><img src=/cyber/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#getting-started>Getting started.</a><ul><li><a href=#create-vm>Create VM.</a></li><li><a href=#override-print>Override <code>print</code>.</a></li><li><a href=#eval-script>Eval script.</a></li></ul></li><li><a href=#module-loader>Module Loader.</a><ul><li><a href=#default-module-loader>Default module loader.</a></li><li><a href=#function-loader>Function loader.</a></li><li><a href=#variable-loader>Variable loader.</a></li><li><a href=#type-loader>Type loader.</a></li></ul></li><li><a href=#host-functions>Host functions.</a></li><li><a href=#host-types>Host types.</a><ul><li><a href=#getchildren><code>getChildren</code></a></li><li><a href=#finalizer><code>finalizer</code></a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=embed-api>Embed API.
<a class=anchor href=#embed-api>#</a></h1><p>The Embed API allows embedding the Cyber compiler and VM as a library into applications. Cyber&rsquo;s core types and the CLI app were built using the Embed API.</p><p>The API is defined in the <a href=https://github.com/fubark/cyber/blob/master/src/include/cyber.h>C header file</a>.
The examples shown below can be found in the repository under <a href=https://github.com/fubark/cyber/blob/master/examples/c-embedded>c-embedded</a>. C is used as the host language, but it can be easily translated to C++ or any C-ABI compatible language.</p><p>Types from the Embed API begin with <code>Cs</code>, constants begin with <code>CS</code>, and functions begin with <code>cs</code>.</p><h2 id=getting-started>Getting started.
<a class=anchor href=#getting-started>#</a></h2><h3 id=create-vm>Create VM.
<a class=anchor href=#create-vm>#</a></h3><p>Most operations are tied to a VM handle. To create a new VM instance, call <code>csCreate</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;cyber.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    CsVM<span style=color:#f92672>*</span> vm <span style=color:#f92672>=</span> <span style=color:#a6e22e>csCreate</span>();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>csDestroy</span>(vm);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=override-print>Override <code>print</code>.
<a class=anchor href=#override-print>#</a></h3><p>The builtin <code>print</code> function does nothing by default, so it needs to be overrided to print to stdout for example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>print</span>(CsVM<span style=color:#f92672>*</span> vm, CsStr str) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;My print: %.*s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, (<span style=color:#66d9ef>int</span>)str.len, str.buf);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>csSetPrint</span>(vm, print);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h3 id=eval-script>Eval script.
<a class=anchor href=#eval-script>#</a></h3><p><code>csEval</code> compiles and evaluates a script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CsStr src <span style=color:#f92672>=</span> <span style=color:#a6e22e>STR</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;var a = 1</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;print(a + 2)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CsValue val;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> <span style=color:#a6e22e>csEval</span>(vm, src, <span style=color:#f92672>&amp;</span>val);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (res <span style=color:#f92672>==</span> CS_SUCCESS) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Success!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>csRelease</span>(vm, val);
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> report <span style=color:#f92672>=</span> <span style=color:#a6e22e>csNewLastErrorReport</span>(vm);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, report);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>csFreeStrZ</span>(report);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If a value is returned from the main block of the script, it&rsquo;s saved to the result value argument.
Memory is managed by ARC so a value that points to a heap object requires a <code>csRelease</code> when it&rsquo;s no longer needed.</p><p><code>csEval</code> returns a result code that indicates whether it was successful.</p><h2 id=module-loader>Module Loader.
<a class=anchor href=#module-loader>#</a></h2><p>A module loader describes how a module is loaded when an <code>import</code> statement is encountered during script execution.
Only one module loader can be active and is set using <code>csSetModuleLoader</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>modLoader</span>(CsVM<span style=color:#f92672>*</span> vm, CsStr spec, CsModuleLoaderResult<span style=color:#f92672>*</span> out) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(<span style=color:#e6db74>&#34;my_mod&#34;</span>, spec.buf, spec.len) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        out<span style=color:#f92672>-&gt;</span>src <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;@host func add(a float, b float) float</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;@host var Root.MyConstant float</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;@host var Root.MyList     List</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;@host</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;type MyCollection object:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;    @host func asList() any&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;@host func MyCollection.new(a, b) MyCollection</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        out<span style=color:#f92672>-&gt;</span>funcLoader <span style=color:#f92672>=</span> funcLoader;
</span></span><span style=display:flex><span>        out<span style=color:#f92672>-&gt;</span>varLoader <span style=color:#f92672>=</span> varLoader;
</span></span><span style=display:flex><span>        out<span style=color:#f92672>-&gt;</span>typeLoader <span style=color:#f92672>=</span> typeLoader;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Fallback to the default module loader to load `builtins`.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>csDefaultModuleLoader</span>(vm, spec, out);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>csSetModuleLoader</span>(vm, modLoader);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>The above example checks whether &ldquo;my_mod&rdquo; was imported and returns it&rsquo;s source code. Additional loaders are returned to load the functions, variables, and types from the source code.</p><h3 id=default-module-loader>Default module loader.
<a class=anchor href=#default-module-loader>#</a></h3><p>Since only one module loader can be set to the VM instance, a custom loader is required to handle the &ldquo;builtins&rdquo; import which contains all of the core types and functions in Cyber. This can simply be delegated to <code>csDefaultModuleLoader</code>.</p><h3 id=function-loader>Function loader.
<a class=anchor href=#function-loader>#</a></h3><p>A function loader describes how to load a <code>@host</code> function when it&rsquo;s encountered by the compiler.
The loader can bind functions and type methods:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> { <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> n; CsFuncFn fn; } funcs[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;add&#34;</span>, add},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;asList&#34;</span>, myCollectionAsList},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;MyCollection.new&#34;</span>, myCollectionNew},
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>funcLoader</span>(CsVM<span style=color:#f92672>*</span> vm, CsFuncInfo info, CsFuncResult<span style=color:#f92672>*</span> out) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check that the name matches before setting the function pointer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(funcs[info.idx].n, info.name.buf, info.name.len) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        out<span style=color:#f92672>-&gt;</span>ptr <span style=color:#f92672>=</span> funcs[info.idx].fn;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This example uses the <code>CsFuncInfo.idx</code> of a @host function to index into an array and return a <a href=#host-functions>Host function</a> pointer. The name is also compared to ensure it&rsquo;s binding to the correct pointer.</p><p>This is an efficient way to map Cyber functions to host functions. A different implementation might use a hash table to map the name of the function to it&rsquo;s pointer.</p><h3 id=variable-loader>Variable loader.
<a class=anchor href=#variable-loader>#</a></h3><p>A variable loader describes how to load a <code>@host</code> variable when it&rsquo;s encountered by the compiler:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// C has limited static initializers (and objects require a vm instance) so initialize them in `main`.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> { <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> n; CsValue v; } NameValue;
</span></span><span style=display:flex><span>NameValue vars[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>varLoader</span>(CsVM<span style=color:#f92672>*</span> vm, CsVarInfo info, CsValue<span style=color:#f92672>*</span> out) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check that the name matches before setting the value.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(vars[info.idx].n, info.name.buf, info.name.len) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Objects are consumed by the module.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>*</span>out <span style=color:#f92672>=</span> vars[info.idx].v;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Initialize var array for loader.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    vars[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> (NameValue){<span style=color:#e6db74>&#34;Root.MyConstant&#34;</span>, <span style=color:#a6e22e>csFloat</span>(<span style=color:#ae81ff>1.23</span>)};
</span></span><span style=display:flex><span>    CsValue myInt <span style=color:#f92672>=</span> <span style=color:#a6e22e>csInteger</span>(<span style=color:#ae81ff>123</span>);
</span></span><span style=display:flex><span>    vars[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> (NameValue){<span style=color:#e6db74>&#34;Root.MyList&#34;</span>, <span style=color:#a6e22e>csNewList</span>(vm, <span style=color:#f92672>&amp;</span>myInt, <span style=color:#ae81ff>1</span>)};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>This example uses the same technique as the function loader, but it can be much simpler. It doesn&rsquo;t matter how the mapping is done as long as the variable loader returns a <code>CsValue</code>.</p><h3 id=type-loader>Type loader.
<a class=anchor href=#type-loader>#</a></h3><p>A type loader describes how to load a <code>@host</code> type when it&rsquo;s encountered by the compiler:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CsTypeId myCollectionId;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>typeLoader</span>(CsVM<span style=color:#f92672>*</span> vm, CsTypeInfo info, CsTypeResult<span style=color:#f92672>*</span> out) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(<span style=color:#e6db74>&#34;MyCollection&#34;</span>, info.name.buf, info.name.len) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        out<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> CS_TYPE_OBJECT;
</span></span><span style=display:flex><span>        out<span style=color:#f92672>-&gt;</span>data.object.outTypeId <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>myCollectionId;
</span></span><span style=display:flex><span>        out<span style=color:#f92672>-&gt;</span>data.object.getChildren <span style=color:#f92672>=</span> myCollectionGetChildren;
</span></span><span style=display:flex><span>        out<span style=color:#f92672>-&gt;</span>data.object.finalizer <span style=color:#f92672>=</span> myCollectionFinalizer;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When binding to the &ldquo;MyCollection&rdquo; type, it&rsquo;s typeId is saved to <code>outTypeId</code>. This id is then used to create new instances of this type. See <a href=#host-types>Host types</a>.</p><h2 id=host-functions>Host functions.
<a class=anchor href=#host-functions>#</a></h2><p>A host function requires a specific function signature:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CsValue <span style=color:#a6e22e>add</span>(CsVM<span style=color:#f92672>*</span> vm, <span style=color:#66d9ef>const</span> CsValue<span style=color:#f92672>*</span> args, <span style=color:#66d9ef>uint8_t</span> nargs) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>double</span> res <span style=color:#f92672>=</span> <span style=color:#a6e22e>csAsFloat</span>(args[<span style=color:#ae81ff>0</span>]) <span style=color:#f92672>+</span> <span style=color:#a6e22e>csAsFloat</span>(args[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>csFloat</span>(res);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A host function should always return a <code>CsValue</code>. <code>csNone()</code> can be returned if the function does not intend to return any value.</p><h2 id=host-types>Host types.
<a class=anchor href=#host-types>#</a></h2><p>A host type are types that are opaque to Cyber scripts but still behave like an object. They can have type functions and methods.</p><p>Only the host application can directly create new instances of them, so usually a function is binded to expose a constructor to the user script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Binding a C struct with it&#39;s own children and finalizer.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// This struct retains 2 VM values and has 2 arbitrary data values unrelated to the VM.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> MyCollection {
</span></span><span style=display:flex><span>    CsValue val1;
</span></span><span style=display:flex><span>    CsValue val2;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> a;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>double</span> b;
</span></span><span style=display:flex><span>} MyCollection;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Implement the `new` function in MyCollection.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>CsValue <span style=color:#a6e22e>myCollectionNew</span>(CsVM<span style=color:#f92672>*</span> vm, <span style=color:#66d9ef>const</span> CsValue<span style=color:#f92672>*</span> args, <span style=color:#66d9ef>uint8_t</span> nargs) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Instantiate our object.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CsValue new <span style=color:#f92672>=</span> <span style=color:#a6e22e>csNewHostObject</span>(vm, myCollectionId, <span style=color:#66d9ef>sizeof</span>(MyCollection));
</span></span><span style=display:flex><span>    MyCollection<span style=color:#f92672>*</span> my <span style=color:#f92672>=</span> (MyCollection<span style=color:#f92672>*</span>)<span style=color:#a6e22e>csAsHostObject</span>(new);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Assign the constructor args passed in and retain them since the new object now references them.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>csRetain</span>(vm, args[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>    my<span style=color:#f92672>-&gt;</span>val1 <span style=color:#f92672>=</span> args[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>csRetain</span>(vm, args[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    my<span style=color:#f92672>-&gt;</span>val2 <span style=color:#f92672>=</span> args[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Assign non VM values.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    my<span style=color:#f92672>-&gt;</span>a <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span>;
</span></span><span style=display:flex><span>    my<span style=color:#f92672>-&gt;</span>b <span style=color:#f92672>=</span> <span style=color:#ae81ff>9999.999</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> new;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>csNewHostObject</code> takes the type id (returned from the <a href=#type-loader>Type loader</a>) and size (in bytes) and returns a new heap object. Note that the size is allowed to vary. Different instances of the same type can occupy different amounts of memory.</p><h3 id=getchildren><code>getChildren</code>
<a class=anchor href=#getchildren>#</a></h3><p>Since <code>MyCollection</code> contains <code>CsValue</code> children, the <a href=#type-loader>Type loader</a> requires a <code>getChildren</code> callback so that memory management can reach them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CsValueSlice <span style=color:#a6e22e>myCollectionGetChildren</span>(CsVM<span style=color:#f92672>*</span> vm, <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> obj) {
</span></span><span style=display:flex><span>    MyCollection<span style=color:#f92672>*</span> my <span style=color:#f92672>=</span> (MyCollection<span style=color:#f92672>*</span>)obj;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (CsValueSlice){ .ptr <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>my<span style=color:#f92672>-&gt;</span>val1, .len <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=finalizer><code>finalizer</code>
<a class=anchor href=#finalizer>#</a></h3><p>A type finalizer is optional since the memory and children of an instance will be freed automatically by ARC.
However, it can be useful to perform additional cleanup tasks for instances that contain external resources.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>myCollectionFinalizer</span>(CsVM<span style=color:#f92672>*</span> vm, <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> obj) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;MyCollection finalizer was called.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/fubark/cyber/edit/master/docs/hugo/content/docs/toc/embedding.md target=_blank rel=noopener><img src=/cyber/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#getting-started>Getting started.</a><ul><li><a href=#create-vm>Create VM.</a></li><li><a href=#override-print>Override <code>print</code>.</a></li><li><a href=#eval-script>Eval script.</a></li></ul></li><li><a href=#module-loader>Module Loader.</a><ul><li><a href=#default-module-loader>Default module loader.</a></li><li><a href=#function-loader>Function loader.</a></li><li><a href=#variable-loader>Variable loader.</a></li><li><a href=#type-loader>Type loader.</a></li></ul></li><li><a href=#host-functions>Host functions.</a></li><li><a href=#host-types>Host types.</a><ul><li><a href=#getchildren><code>getChildren</code></a></li><li><a href=#finalizer><code>finalizer</code></a></li></ul></li></ul></nav></div></aside></main><script src=/cyber/highlight.min.js></script><script>hljs.registerLanguage("cy",function(){return{keywords:{keyword:["func","import","for","coinit","coresume","coyield","return","if","else","as","while","var","my","object","with","caught","break","continue","switch","pass","or","and","not","is","error","throws","true","false","none","throw","try","catch","recover","enum","type","case"],type:["float","string","bool","any","int","List","Map","rawstring","symbol","pointer","dynamic"]},contains:[{scope:"string",begin:"'",end:"'"},{scope:"symbol",begin:"#",end:/\w(?=[^\w])/},hljs.COMMENT("--",`
`,{contains:[]}),hljs.C_NUMBER_MODE]}}),hljs.highlightAll()</script></body></html>